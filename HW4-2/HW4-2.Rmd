---
title: "HW 4.2"
author: "Hayden Atchley"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
geometry: margin=1in
output:
  pdf_document:
    latex_engine: lualatex
    includes:
      in_header: "preamble.tex"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r load_packages, include=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  pacman,
  tidyverse,
  flextable,
  knitr,
  magrittr,
  mlogit,
  broom,
  modelsummary
  )
```

```{r functions, include=FALSE}
my_flextable <- function(tibble){
  flextable(tibble) %>%
  autofit() %>%
  align(align = "center", part = "all")
}

my_msummary <- function(models){
  modelsummary(
    models,
    output = "flextable",
    estimate = "{estimate} ({std.error}){stars}",
    statistic = NULL,
    gof_omit = ".IC"
  ) %>%
    autofit() %>%
    vline(j = 1)
}
```

\RaggedRight

In order to estimate the models, we first need to load the data:
```{r load}
worktrips <- read_rds("data/worktrips_dfidx.rds")
```

4.5
============================
The first model I estimated with cost, travel time, OVTT, and employment density.
I nested this model based on car vs. non-car modes, and constrained the nesting parameter to a single value:
```{r nl1}
nl1 <- mlogit(CHOSEN ~ COST + TVTT  + OVTT | WKEMPDEN,
              data = worktrips,
              nests = list(auto = c('Drive Alone', 'Share 2', 'Share 3+'),
                           nonauto = c('Bike', 'Walk', 'Transit')),
              un.nest.el = T)
my_msummary(list(nested_model = nl1)) %>%
  align(j = 2, align = "center", part = "all")
```
Looking at the nesting value gives:
```{r nl1_nest_value}
nl1$coefficients["iv"]
```
This is a problematic value, as it is greater than 1.
If we used this value, then a decrease in utility would cause people to choose that mode more.
Because of this, we should either set the nesting parameter to equal 1 (effectively un-nesting the mode choice), or possibly set the `un.nest.el` argument to be `FALSE`, which would give us different nesting parameters for each nest (some of which may be less than 1 and useable).


4.6
=================================
The next models are segmented based on income, with $50,000 as the cutoff point.
I also added vehicles per worker (`VEHBYWRK`) as a covariate:
```{r nl2}
nl2A <- mlogit(CHOSEN ~ COST + TVTT  + OVTT | WKEMPDEN + VEHBYWRK,
               data = worktrips %>% filter(HHINC < 50),
               nests = list(auto = c('Drive Alone', 'Share 2', 'Share 3+'),
                            nonauto = c('Bike', 'Walk', 'Transit')),
               un.nest.el = T)

nl2B <- mlogit(CHOSEN ~ COST + TVTT  + OVTT | WKEMPDEN + VEHBYWRK,
               data = worktrips %>% filter(HHINC > 50),
               nests = list(auto = c('Drive Alone', 'Share 2', 'Share 3+'),
                            nonauto = c('Bike', 'Walk', 'Transit')),
               un.nest.el = T)

my_msummary(list(`< $50,000` = nl2A, `> $50,000` = nl2B))
```

