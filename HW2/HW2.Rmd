---
title: 'Homework 2: Trip Generation'
author: "Hayden Atchley"
date: "9/22/2021"
output:
  pdf_document:
    latex_engine: lualatex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r load_packages, message=FALSE, include=FALSE}
if(!require(pacman)) install.packages(pacman)
pacman::p_load(pacman, tidyverse, remotes, knitr, sjlabelled, flextable, jtools)
remotes::install_github("byu-transpolab/nhts2017")
p_load(nhts2017)
options(dplyr.summarise.inform = FALSE)
set_flextable_defaults(fonts_ignore=TRUE)
```

Loading the data
================================================================================
I followed the instructions provided in the textbook for loading the data. The following is the R code I used, and the output:
\bigskip

```{r load_data, echo=TRUE, message=FALSE, warning=FALSE}
hh <- nhts_households %>% 
  # filter to MSA size 2, travel on weekday
  filter(msasize == "02", !travday %in% c("01", "07")) %>%
  # select the columns we care about.
  select(houseid, wthhfin, hhsize, hhvehcnt, numadlt, hhfaminc, wrkcount) %>%
  mutate(
    hhsize = ifelse(hhsize > 4, 4, hhsize),
    hhvehcnt = ifelse(hhvehcnt > 3, 3, hhvehcnt),
    wrkcount = ifelse(wrkcount > 2, 2, wrkcount)
  )

trips <- nhts_trips %>% 
  # filter to households in the data
  filter(houseid %in% hh$houseid) %>%
  group_by(houseid, trippurp) %>%
  # count up how many trips each household took
  summarise(trips = n()) %>%
  # "spread" the data, filling zero if no trips were taken
  pivot_wider(id_cols = houseid, names_from = trippurp, 
              values_from = trips, values_fill = 0)

# function to change NA to 0
nato0 <- function(x) {ifelse(is.na(x), 0, x)}

tripprod <- hh %>% 
  # join tables by id field
  left_join(trips, by = "houseid") %>%
  # change all NA values in columns from the trips data to 0
  mutate_at(vars(names(trips)), nato0)

# Format table
tripprod %>%
  head(n = 10L) %>%
  flextable() %>%
  theme_booktabs() %>%
  align(align = "center", part = "all") %>%
  autofit(add_w = 0, add_h = 0) %>%
  fit_to_width(6)
```


2.1
================================================================================
Using this data, we can calculate trip rates by household size and income group:
```{r hh_size_and_income}
tripprod$hhfaminc <- as_factor(tripprod$hhfaminc) #better data type for manipulation
tripprod <- tripprod %>%
  filter(!hhfaminc %in% c("-7", "-8", "-9")) %>%
  group_by(hhsize, hhfaminc) %>%
  arrange(hhsize, hhfaminc)
tripprod$hhfaminc <- as_label(tripprod$hhfaminc) #to show text instead of numbers

tripprod %>%
  summarize(
    n = n(),
    HBW = weighted.mean(HBW, wthhfin),
    HBSHOP = weighted.mean(HBSHOP, wthhfin),
    HBSOCREC = weighted.mean(HBSOCREC, wthhfin),
    HBO = weighted.mean(HBO, wthhfin),
    NHB = weighted.mean(NHB, wthhfin),
    "\U03A3" = HBW + HBSHOP + HBSOCREC + HBO + NHB
  ) %>%
  #Create table
  flextable() %>%
  theme_booktabs() %>%
  colformat_double(j = 2:9,digits = 2) %>%
  align(align = "center", part = "all") %>%
  autofit(add_w = 0, add_h = 0) %>%
  fit_to_width(6) %>%
  hline(i = seq(11, 44, 11))
```
Generally, this data seems to make sense: a larger household size will produce more trips, and a higher income roughly will produce more trips as well. In most of the household sizes, the HBW (and total) trip rates peak somewhere around the $150,000 range, which makes sense as after a certain level of income, possibly fewer trips are needed as more executive positions may be easier to do remotely. The HBSOCREC trips also increase generally with income, which makes sense, though there are quite a few specific numbers that don't follow this trend. Most of these are from groups with small sample sizes however, so the exact numbers may not represent a realistic average.

\pagebreak

2.2
================================================================================
We can use a similar process to calculate trip rates by household workers and vehicles:
```{r hh_emp_and_veh}
tripprod %>%
  group_by(wrkcount, hhvehcnt) %>%
  arrange(wrkcount, hhvehcnt) %>%
  summarize(
    n = n(),
    HBW = weighted.mean(HBW, wthhfin),
    HBSHOP = weighted.mean(HBSHOP, wthhfin),
    HBSOCREC = weighted.mean(HBSOCREC, wthhfin),
    HBO = weighted.mean(HBO, wthhfin),
    NHB = weighted.mean(NHB, wthhfin),
    "\U03A3" = HBW + HBSHOP + HBSOCREC + HBO + NHB
  ) %>%
  flextable() %>%
  theme_booktabs() %>%
  colformat_double(j = 3:9,digits = 2) %>%
  align(align = "center", part = "all") %>%
  autofit(add_w = 0, add_h = 0) %>%
  fit_to_width(6)
```
This data also roughly makes sense, as trips go up with number of workers and number of vehicles. However, there are some unexpected data points: as an example, a 2-worker 0-vehicle (2W0V) household makes almost twice as many HBW trips as a 2W1V household. I can think of two things that might contribute to this though: the very small number of observations for the 2W0V category (which can introduce statistical error), and that with a car it is much more likely for workers to stop at a different activity on their way to or from work than if they were relying on transit or walking/biking. Overall, the data seems to be mostly good, but may require some tweaking to achieve more realistic numbers.


2.3
================================================================================
We can calculate the standard deviation in trip rates by household size/vehicle count and number of workers/vehicle count:
```{r table_format, include=FALSE}
#Write formatting function to avoid clutter
format_my_table <- function(.data) {
  flextable(.data) %>%
  delete_part(part = "header") %>%
  add_header(hhvehcnt = "Household Vehicles",
             `1.x` = "1", `2.x` = "2", `3` = "3", `4` = "4",
             `0` = "0", `1.y` = "1", `2.y` = "2") %>%
  add_header(hhvehcnt = "",
             `1.x` = "Size", `2.x` = "Size", `3` = "Size", `4` = "Size",
             `0` = "Workers", `1.y` = "Workers", `2.y` = "Workers" ) %>%
  merge_h(part = "header") %>%
  theme_booktabs() %>%
  colformat_double(j = 2:8, digits = 2) %>%
  align(align = "center", part = "all") %>%
  autofit(add_w = 0, add_h = 0) %>%
  vline(j = c("hhvehcnt", "4"))
}
```

```{r sd_veh_and_size_and_emp}
size <- tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  arrange(hhsize, hhvehcnt) %>%
  summarise(HBW = wtd.sd(HBW, wthhfin)) %>%
  pivot_wider(names_from = hhsize, values_from = HBW)
emp <- tripprod %>%
  group_by(wrkcount, hhvehcnt) %>%
  arrange(wrkcount, hhvehcnt) %>%
  summarise(HBW = wtd.sd(HBW, wthhfin)) %>%
  pivot_wider(names_from = wrkcount, values_from = HBW)

left_join(size, emp, by = "hhvehcnt") %>%
  format_my_table() %>%  #Custom function to avoid clutter
  set_caption("Weighted standard deviations of HBW trips",
              autonum = F)
```
Some of these standard deviations are quite small relative to the trip rate, but a lot are fairly large, and many even exceed the trip rate itself. This is somewhat to be expected though, given the small sample size of many of the categories (see Problem 2.4). For estimating work trips, it may make sense to use the number of workers rather than the household size, but since all other trip types are estimated based on household size, it would be practical to do the same for work trips. Both household size and worker count seem to correlate well enough that it shouldn't make a drastic difference in the model.


2.4
================================================================================
We can use a similar process to find the number of trips in each category:
```{r n_veh_and_size_and_emp}
size <- tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  arrange(hhsize, hhvehcnt) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = hhsize, values_from = n)
emp <- tripprod %>%
  group_by(wrkcount, hhvehcnt) %>%
  arrange(wrkcount, hhvehcnt) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = wrkcount, values_from = n)

left_join(size, emp, by = "hhvehcnt") %>%
  format_my_table() %>%  #Custom function to avoid clutter
  set_caption("Number of households in each classification",
              autonum = F)
```
Clearly some of the household types have very few observations, which (at least partly) explains why many of the data points in the previous problems don't always make sense. For example, there are 8 0-vehicle/2-worker households out of the thousands of total households, which is not at all a large enough sample size to generate any meaningful trip rates. However, trip rates for these households can likely be estimated to somewhat realistic values using the rest of the data, and in fact may already represent realistic values, even if the confidence intervals are quite wide.


2.5
================================================================================
In order to create trip attraction models, first we need to download the PSRC data with trip attractions and other useful variables by tract:
```{r trip_attr}
psrc_attractions <- read_csv(
  "https://byu.box.com/shared/static/7ci8vomip719bdno7xl5ftjj940dausm.csv"
  )
```
Now we can estimate models for trip attraction based on these variables:
```{r attr_models_prelim}
lm(data = psrc_attractions, HBW ~ tothh + retl + manu + offi + gved + othr + totemp) %>%
  summary()
```
Looking at these estimates presents a few immediate problems: for one, the coefficients for retail and manufacturing jobs are negative, and the intercept is very low as well, implying a TAZ with no jobs or households would attract -1768 trips. I also included total employment as well as each employment type variable, which doesn't make too much sense.

After some experimentation, these are the models I settled on:
```{r attr_models}
HBWlm <- lm(data = psrc_attractions, HBW ~ totemp)
summary(HBWlm)
HBShoplm <- lm(data = psrc_attractions, HBShop ~ retl)
summary(HBShoplm)
HBOlm <- lm(data = psrc_attractions, HBO ~ tothh + retl)
summary(HBOlm)
NHBlm <- lm(data = psrc_attractions, NHB ~ retl + offi + gved)
summary(NHBlm)
```



2.6
================================================================================
Most of these trip attraction models seem to be reasonable: work trips correlate with employment, shopping with retail, etc. NHB trips correlate with certain types of employment and retail, suggesting that office and government employees are likely to go shopping right after work. Manufacturing jobs didn't correlate well with NHB trips though, and I would suspect this has to do with income (manufacturing jobs can often pay less than office jobs), though there may be other factors as well.

None of the \(R^2\) values are particularly good, but the HBW model has a decent \(R^2\) of \(0.44\). The only significant variable that HBW trips correlated well with was total employment, which makes sense and would largely explain the relatively high \(R^2\) value.


2.7
================================================================================
Here are the models with the intercept removed:
```{r attr_models_no_int}
HBWlmNI <- lm(data = psrc_attractions, HBW ~ totemp - 1)
summary(HBWlmNI)
HBShoplmNI <- lm(data = psrc_attractions, HBShop ~ retl - 1)
summary(HBShoplmNI)
HBOlmNI <- lm(data = psrc_attractions, HBO ~ tothh + retl - 1)
summary(HBOlmNI)
NHBlmNI <- lm(data = psrc_attractions, NHB ~ retl + offi + gved - 1)
summary(NHBlmNI)
```
All of the \(R^2\) values increased with the intercept removed, but this is misleading, as the \(R^2\) value is now comparing against a random guess for the trip rates rather than against the average trip rates. Basically these \(R^2\) values are meaningless, and we should definitely keep the intercept in. However, it may be wise to use a piecewise linear model in order to account for the fact that sparse TAZs would attract close to zero trips, rather than the intercept's number of trips. However, that is outside the scope of the assignment, so will not be done here.