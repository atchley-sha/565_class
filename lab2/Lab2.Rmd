---
title: 'Lab 2: Trip Production'
date: "9/27/2021"
output:
  pdf_document:
    latex_engine: lualatex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r load_packages, message=FALSE, include=FALSE}
if(!require(pacman)) install.packages(pacman)
pacman::p_load(
  pacman,
  tidyverse,
  remotes,
  knitr,
  sjlabelled,
  flextable,
  jtools,
  foreign,
  scales
  )
if(!require(nhts2017)) remotes::install_github("byu-transpolab/nhts2017")
p_load(nhts2017)

options(dplyr.summarise.inform = FALSE)
set_flextable_defaults(fonts_ignore=TRUE)
```


Trip Production Rates
=================================
Many of the original trip production rates provided in the Cube scenario are set at 1 across the board, regardless of purpose, number of vehicles, etc. This is obviously not realistic, so we need to use different data. We used the data from the NHTS 2017 report, which we worked with in HW #2 as well. The data manipulation required to get these values is very similar to that from HW #2, so we present just the results here:

```{r load_data, echo=FALSE}
hh <- nhts_households %>%
  # filter to MSA size 2, travel on weekday
  filter(msasize == "02", !travday %in% c("01", "07")) %>%
  # select the columns we care about.
  select(houseid, wthhfin, hhsize, hhvehcnt, numadlt, hhfaminc, wrkcount) %>%
  mutate(
    hhsize = ifelse(hhsize > 4, 4, hhsize),
    hhvehcnt = ifelse(hhvehcnt > 3, 3, hhvehcnt),
    wrkcount = ifelse(wrkcount > 2, 2, wrkcount)
  )

trips <- nhts_trips %>%
  # filter to households in the data
  filter(houseid %in% hh$houseid) %>%
  group_by(houseid, trippurp) %>%
  # count up how many trips each household took
  summarise(trips = n()) %>%
  # "spread" the data, filling zero if no trips were taken
  pivot_wider(id_cols = houseid, names_from = trippurp,
    values_from = trips, values_fill = 0)

# function to change NA to 0
nato0 <- function(x) {ifelse(is.na(x), 0, x)}

tripprod <- hh %>%
  # join tables by id field
  left_join(trips, by = "houseid") %>%
  # change all NA values in columns from the trips data to 0
  mutate_at(vars(names(trips)), nato0)


##Create tables ####

###formatting tables function
my_flextable <- function(tibble){
  flextable(tibble) %>%
  autofit() %>%
  align(align = "center", part = "all")
}
###

#For HBW
tripprod %>%
  group_by(wrkcount, hhvehcnt) %>%
  summarize(
    HBW = weighted.mean(HBW, wthhfin)
   ) %>%
  mutate(hhvehcnt = paste(hhvehcnt, "vehicles")) %>%
  pivot_wider(names_from = hhvehcnt, values_from = HBW) %>%
  round(digits = 3) %>%
  my_flextable() %>%
  add_header_lines("HBW")

#For HBSHOP
tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  summarize(
    HBSHOP = weighted.mean(HBSHOP, wthhfin)
   ) %>%
  mutate(hhvehcnt = paste(hhvehcnt, "vehicles")) %>%
  pivot_wider(names_from = hhvehcnt, values_from = HBSHOP) %>%
  round(digits = 3) %>%
  my_flextable() %>%
  add_header_lines("HBSHOP")

#For HBO
tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  summarize(
    HBO = weighted.mean(HBO, wthhfin)
   ) %>%
  mutate(hhvehcnt = paste(hhvehcnt, "vehicles")) %>%
  pivot_wider(names_from = hhvehcnt, values_from = HBO) %>%
  round(digits = 3) %>%
  my_flextable() %>%
  add_header_lines("HBO")
```

We also calculated the 95% confidence intervals for each trip type, in case we need to adjust them later:
```{r sample_se, echo=TRUE}
#For HBW
tripprod %>%
  group_by(wrkcount, hhvehcnt) %>%
  summarize(
    n = n(),
    HBWsd = wtd.sd(HBW, wthhfin)
   ) %>%
  mutate(
    conf = 1.96 * HBWsd / n^2,
    conf_sci = ifelse(conf < 0.001, scientific(conf, digits = 3), round(conf, digits = 3)),
    hhvehcnt = paste(hhvehcnt, "vehicles")
    ) %>%
  pivot_wider(id_cols = wrkcount, names_from = hhvehcnt, values_from = conf_sci) %>%
  my_flextable() %>%
  add_header_lines("HBW Confidence Intervals")
```
(Note the code is virtually same for the other purposes)
```{r se, echo=FALSE}
#For HBSHOP
tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  summarize(
    n = n(),
    HBSHOPsd = wtd.sd(HBSHOP, wthhfin)
   ) %>%
  mutate(
    conf = 1.96 * HBSHOPsd / n^2,
    conf_sci = ifelse(conf < 0.001, scientific(conf, digits = 3), round(conf, digits = 3)),
    hhvehcnt = paste(hhvehcnt, "vehicles")
    ) %>%
  pivot_wider(id_cols = hhsize, names_from = hhvehcnt, values_from = conf_sci) %>%
  my_flextable() %>%
  add_header_lines("HBSHOP Confidence Intervals")

#For HBO
tripprod %>%
  group_by(hhsize, hhvehcnt) %>%
  summarize(
    n = n(),
    HBOsd = wtd.sd(HBO, wthhfin)
   ) %>%
  mutate(
    conf = 1.96 * HBOsd / n^2,
    conf_sci = ifelse(conf < 0.001, scientific(conf, digits = 3), round(conf, digits = 3)),
    hhvehcnt = paste(hhvehcnt, "vehicles")
    ) %>%
  pivot_wider(id_cols = hhsize, names_from = hhvehcnt, values_from = conf_sci) %>%
  my_flextable() %>%
  add_header_lines("HBO Confidence Intervals")
```

We then wrote these tables to their respective .dbf files and ran the Trip Generation submodel in Cube. Ideally, the total output trips would be somewhat close to the NHTS reported total weighted trips for the area.

