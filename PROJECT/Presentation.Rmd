---
title: "565 Presentation"
author: "Hayden Atchley, Tristan Parker, Steven Goodsell, Austin Nichalson"
date: "12/8/2021"
output:
  ioslides_presentation:
    transition: faster
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r load_packages, include=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  char = as.character(read.csv("packages.csv", header = F)[,1])
)
install_github("atchley-sha/R-packageSHA")
library(packageSHA)
```

```{r load_functions, include=FALSE}
source("R/functions.R")
```

```{r}
#Line size
size = 1.5
```

## Question {.build}

Would densifying the population mitigate problems like congestion and encourage multi-modal transportation?

<div>

### Scenarios

- No build 2040
- 30% move downtown
- 30% move to "neighborhood centers"

</div>

## SE Data: No-Build

```{r}
senb <- read.dbf("data/se/se_classified_2040_NO-BUILD.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK)
sedt <- read.dbf("data/se/se_downtown30.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK)
senc <- read.dbf("data/se/se_neighborhood30.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK)

TAZ <- read_sf("data/TAZ/RoanokeTAZ.shp") %>% 
  select(ZONE)

maxpop <- max(c(senb$POP, sedt$POP, senc$POP))
maxwork <- max(c(senb$WORK, sedt$WORK, senc$WORK))
```


```{r}
#TAZ by population
TAZNB <- left_join(TAZ, senb, by = c("ZONE" = "Z"))

TAZNB %>% 
  ggplot() +
  geom_sf(aes(fill = POP)) +
  theme_void() +
  scale_fill_gradient(limits = c(0, maxpop), low = "lightblue", high = "red")
#TAZ by jobs?
```


## SE Data: Downtown

```{r}
#TAZ by population
TAZDT <- left_join(TAZ, sedt, by = c("ZONE" = "Z"))

TAZDT %>% 
  ggplot() +
  geom_sf(aes(fill = POP)) +
  theme_void() +
  scale_fill_gradient(limits = c(0, maxpop), low = "lightblue", high = "red")
#TAZ by jobs?
```


## SE Data: Neighborhood Centers

```{r}
#TAZ by population
TAZNC <- left_join(TAZ, senc, by = c("ZONE" = "Z"))

TAZNC %>% 
  ggplot() +
  geom_sf(aes(fill = POP)) +
  theme_void() +
  scale_fill_gradient(limits = c(0, maxpop), low = "lightblue", high = "red")
#TAZ by jobs?
```


# Outputs #####################################################


## Mode Choice

```{r}
modeChoice <- read_csv("data/modeChoice.csv")

modeChoice$scenario %<>%
  as.factor() %>% 
  recode_factor("2040 Base" = "No-Build") %>% 
  fct_relevel("Neighborhood Centers", "Downtown", "No-Build") 
  

ggplot(modeChoice) +
  geom_bar(aes(x = trips, y = scenario, fill = mode),
           stat = "identity",
           position = "fill") +
  xlab("Proportion of Trips") +
  ylab("") +
  labs(fill = "Mode")
```


## Volume: No-Build

```{r load_data_congestion}
noBuild <- read_sf("data/loaded_networks/NoBuild.shp")
DT30 <- read_sf("data/loaded_networks/DT30.shp")
NC30 <- read_sf("data/loaded_networks/NC30.shp")

bbox <- list(x = c(st_bbox(noBuild)$xmin, st_bbox(noBuild)$xmax),
             y = c(st_bbox(noBuild)$ymin, st_bbox(noBuild)$ymax))

breaks <- get_breaks(noBuild)$breaks
labels <- get_breaks(noBuild)$labels
colors <- colorRampPalette(c("lightblue", "darkred"))(5)
```

```{r}
categorize_congestion(noBuild, breaks, labels) %>% 
  ggplot() +
  geom_sf(aes(color = VOL_CAT), size = size) +
  theme_void() +
  scale_color_manual(values = colors) +
  labs(color = "Total Volume")
```

## Volume: Downtown

```{r}
categorize_congestion(DT30, breaks, labels) %>% 
  ggplot() +
  geom_sf(aes(color = VOL_CAT), size = size) +
  theme_void() +
  scale_color_manual(values = colors) +
  labs(color = "Total Volume")
```

## Volume: Neighborhood Centers

```{r}
categorize_congestion(NC30, breaks, labels) %>% 
  ggplot() +
  geom_sf(aes(color = VOL_CAT), size = size) +
  theme_void() +
  scale_color_manual(values = colors) +
  labs(color = "Total Volume")
```


## Congestion: No-Build

```{r}
limits <- c(min = 0, max = 1.5)
# limits <- c(min = 0, max = max(c(noBuild$PM_VC, DT30$PM_VC, NC30$PM_VC)))
breaks <- c(1,2,3,4,5)*0.25
```

```{r}
ggplot(noBuild) +
  geom_sf(aes(color = PM_VC), size = size) +
  theme_void() +
  scale_color_steps(low = "lightblue", high = "red", limits = limits, breaks = breaks) +
  labs(color = "PM V/C Ratio")
```

## Congestion: Downtown

```{r}
ggplot(DT30) +
  geom_sf(aes(color = PM_VC), size = size) +
  theme_void() +
  scale_color_steps(low = "lightblue", high = "red", limits = limits, breaks = breaks) +
  labs(color = "PM V/C Ratio")
```

## Congestion: Neighborhood Centers

```{r}
ggplot(NC30) +
  geom_sf(aes(color = PM_VC), size = size) +
  theme_void() +
  scale_color_steps(low = "lightblue", high = "red", limits = limits, breaks = breaks) +
  labs(color = "PM V/C Ratio")
```


## V/C Difference from No-Build: Downtown

```{r}
calculate_differences(new = DT30, col = PM_VC) %>% 
  ggplot() +
  geom_sf(aes(color = DIFF), size = size) +
  theme_void() +
  scale_color_gradient2(low = "blue", mid = "gray80", high = "red")
```

## V/C Difference from No-Build: Neighborhood Centers

```{r}
calculate_differences(new = NC30, col = PM_VC) %>% 
  ggplot() +
  geom_sf(aes(color = DIFF), size = size) +
  theme_void() +
  scale_color_gradient2(low = "blue", mid = "gray80", high = "red")
```


## Conclusions

- Downtown seems best
- Multimodal use, lower emissions
- Further research on transit/land use changes

