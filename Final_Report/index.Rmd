---
title: "Population and Job Densification in Roanoke"
author: "Hayden Atchley, Steven Goodsell, Austin Nichalson, Tristan Parker"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
documentclass: article
site: bookdown::bookdown_site
geometry: margin=1in
output:
  pdf_document: 
    toc: true
    fig_caption: yes
    includes:
      in_header: preamble.tex
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.pos = "H",
	out.extra = "",
	fig.height = 4
)
```

```{r load-packages, include=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  char = as.character(read.csv("packages.csv", header = F)[,1])
  )
install_github("atchley-sha/R-packageSHA")
library(packageSHA)
```

```{r load-functions}
source("R/functions.R")
```

\pagebreak

# Introduction

Would densifying Roanoke’s population and jobs in certain locations encourage multi-modal transportation and reduce problems like congestion? To seek answers to this question, our team used a trip-based model and changed the land-use inputs in the model by editing the projected 2040 social economic (SE) data. This allowed us to see how localizing population and job growth in the downtown area compares with the no-build 2040 scenario. We also wished to look at the effects of densifying "neighborhood centers" in comparison with the no-build scenario. We seek to identify if one or both of these land use policy changes would affect mode choice and traffic congestion, and to make a recommendation based on our findings.

# Proposed Scenarios

Our first scenario is the projected "No-Build" 2040 scenario, as given already in CUBE. For our other scenarios, we identified TAZs that we considered "Downtown", as well as those we considered "Neighborhood Centers". We mainly looked at the Area Type as given in the input data to determine these TAZs (with Downtown being urban and Neighborhood Centers being Exurban), but we adjusted our selections slightly to preserve continuity and cohesiveness. The area types and selected TAZs are shown in Figure \@ref(fig:TAZTypes).

```{r TAZTypes, fig.cap="Population density and selected TAZs for Downtown and Neighborhood Centers scenarios."}

#Set downtown zone IDs
DTZones <- c(88,89,90,91,92,
             93,102,117,118,119,
             126,127,128,129,130,
             131,132,133,134,145,
             195,196,197,198,200,
             201)

#Set neighborhood centers zone IDs
NCZones <- c(42,66,97,148,149,
             160,161,176,177,178,
             179,180,181)

TAZsf <- read_sf("data/TAZ/RoanokeTAZ.shp") %>% 
  select(ID, ZONE, N)

TAZdbf <- read.dbf("data/se/se_classified_2040_NO-BUILD.dbf") %>% 
  mutate(designation = case_when(Z %in% DTZones ~ "Downtown",
                          Z %in% NCZones ~ "Neighborhood Centers",
                          TRUE ~ "Rural") %>% 
           as.factor() %>% 
           fct_relevel(
             "Rural",
             "Neighborhood Centers",
             "Downtown"
           )) %>% 
  select(Z, designation)

TAZtype <- read.dbf("data/ZONAL AT2040A.DBF")

TAZ <- left_join(TAZsf, TAZtype, by = c("N" = "N")) %>% 
  left_join(TAZdbf, by = c("ZONE" = "Z"))

TAZ$ATYPE <-  factor(
  TAZ$ATYPE,
  labels = c("2 - Urban",
             "3 - Exurban",
             "4 - Suburban",
             "5 - Rural"))

TAZsplit <- TAZ %>% 
  group_by(designation) %>% 
  group_split()

fillColors <- brewer.pal(4, "Oranges") %>% rev()
colorColors <- c("grey60", "blue", "black")
borderSize <- 0.7

ggplot(TAZ) +
  geom_sf(aes(fill = ATYPE, color = designation)) +
  theme_void() +
  scale_fill_manual(values = fillColors) +
  scale_color_manual(values = colorColors) +
  guides(color = guide_legend(override.aes = list(size = 1))) +
  geom_sf(data = TAZsplit[[2]], fill = NA, color = colorColors[2], size = borderSize) +
  geom_sf(data = TAZsplit[[3]], fill = NA, color = colorColors[3], size = borderSize) +
  labs(
    fill = "Area Type",
    color = "Designation"
  )

```

As a side note, this figure shows that we had one obviously erroneous zone designated as Downtown. This is likely due to the fact that the TAZ data has three almost identical identification columns, and we may have mismatched them when combining the various input data files. This was an oversight on our part, but we unfortunately did not have time to fix the error. Most of the findings should still be roughly accurate, however, as only a couple of zones were affected.

To create the other scenarios, we adjusted the No-Build socioeconomic input data by moving 30% of the population, jobs, etc. from the rural areas to the downtown and neighborhood centers areas, respectively. Figure \@ref(fig:populationMap) shows the No-Build population and employment density by TAZ, and Figures \@ref(fig:DTPOPDiff) and \@ref(fig:NCPOPDiff) show the change from the No-Build scenario.

```{r loadSEData}
senb <- read.dbf("data/se/se_classified_2040_NO-BUILD.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK) %>% 
  mutate(total = POP + WORK)
sedt <- read.dbf("data/se/se_downtown30.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK) %>% 
  mutate(total = POP + WORK) %>% 
  calculate_differences(col = total, base = senb)
senc <- read.dbf("data/se/se_neighborhood30.dbf") %>% 
  as_tibble() %>% 
  select(Z, POP, WORK) %>% 
  mutate(total = POP + WORK) %>% 
  calculate_differences(col = total, base = senb)

TAZ <- read_sf("data/TAZ/RoanokeTAZ.shp") %>% 
  select(ID, ZONE, N)

```

```{r populationMap, fig.cap="Population by TAZ in No-Build scenario."}
TAZNB <- left_join(TAZ, senb, by = c("ZONE" = "Z"))

TAZNB %>% 
  ggplot() +
  geom_sf(aes(fill = total)) +
  theme_void() +
  scale_fill_gradient(low = "lightblue", high = "red") +
  labs(fill = "Population\n+ Employment")
```

```{r DTPOPDiff, fig.height=3, fig.cap="Population difference in Downtown scenario from No-Build."}
TAZDT <- left_join(TAZ, sedt, by = c("ZONE" = "Z"))

ggplot(TAZDT) +
  geom_sf(aes(fill = DIFF)) +
  theme_void() +
  scale_fill_gradient2(low = "blue", mid = "gray80", high = "red") +
  labs(fill = "Population Difference\nfrom No-Build")
```

```{r NCPOPDiff, fig.height=3, fig.cap="Population difference in Neighborhood Centers scenario from No-Build."}
TAZNC <- left_join(TAZ, senc, by = c("ZONE" = "Z"))

ggplot(TAZNC) +
  geom_sf(aes(fill = DIFF)) +
  theme_void() +
  scale_fill_gradient2(low = "blue", mid = "gray80", high = "red") +
  labs(fill = "Population Difference\nfrom No-Build")
```


\pagebreak

# Scenario Analysis

## Mode Choice

Both densification models significantly impacted the transportation system in Roanoke. Densifying the downtown area resulted in significantly more non-motorized trips, more than double transit trips, and fewer automobile trips overall. Focusing the densification in the selected neighborhood centers resulted in similarly increased non-motorized and transit trips, though not as dramatically, and decreased automobile trips. Figure \@ref(fig:modeChoice) shows the mode choice distributions between the three models (taken as averages across all trip purposes).

```{r modeChoice, fig.cap="Mode choice distribution in each scenario."}
modeChoice <- read_csv("data/modeChoice.csv")

modeChoice$scenario %<>%
  as.factor() %>% 
  recode_factor("2040 Base" = "No-Build") %>% 
  fct_relevel("Neighborhood Centers", "Downtown", "No-Build") 
  

ggplot(modeChoice) +
  geom_bar(aes(x = trips, y = scenario, fill = mode),
           stat = "identity",
           position = "fill") +
  xlab("Proportion of Trips") +
  ylab("") +
  labs(fill = "Mode")
```

Both alternatives showed increased transit use over the No-Build scenario: the No-Build scenario predicted 7,794 boardings during peak transit hours, while the Neighborhood Centers and Downtown scenarios predicted 11,341 and 15,686 boardings, respectively. The Downtown scenario predicts more than double the transit ridership over the No-Build.

## Congestion

We used the volume to capacity ratio (V/C) as a rough measure of congestion. The Downtown scenario expectedly shows increased congestion in the downtown areas and decreased congestion outside of that (Figure \@ref(fig:VCDT)). A similar trend can be seen in the Neighborhood Centers scenario with its respective areas (Figure \@ref(fig:VCNC)).

```{r}
noBuild <- read_sf("data/loaded_networks/NoBuild.shp")
DT30 <- read_sf("data/loaded_networks/DT30.shp")
NC30 <- read_sf("data/loaded_networks/NC30.shp")

size = 1.1
```

```{r VCDT, fig.height=3, fig.cap="Difference in V/C in Downtown scenario compared to No-Build."}
calculate_differences(new = DT30, col = PM_VC) %>% 
  ggplot() +
  geom_sf(aes(color = DIFF), size = size) +
  theme_void() +
  scale_color_gradient2(low = "blue", mid = "gray80", high = "red") +
  labs(color = "V/C Difference\nfrom No-Build")
```

```{r VCNC, fig.height=3, fig.cap="Difference in V/C in Neighborhood Centers scenario compared to No-Build."}
calculate_differences(new = NC30, col = PM_VC) %>% 
  ggplot() +
  geom_sf(aes(color = DIFF), size = size) +
  theme_void() +
  scale_color_gradient2(low = "blue", mid = "gray80", high = "red") +
  labs(color = "V/C Difference\nfrom No-Build")
```

These figures use the arithmetic difference between V/C ratios, so an increase of 0.5 indicates that the volume increased by half the capacity of the link. It is potentially concerning that there are some links that show an increase in V/C of 1, but there are only a couple small links for which that is the case. Since CUBE designates trips between TAZs rather than between coordinates, it could be that these links are the only path available in the model, but in reality there may be other roads drivers could use.

It is worth noting that these scenarios don't take into account any new transportation infrastructure. It is no surprise then that a significant population increase would result in severe congestion on existing roadways. An increased investment into transit or other infrastructure could potentially alleviate most of this problem, but that would require further research and analysis.

## VMT and VHT

A notable impact on vehicle miles traveled (VMT) and vehicle hours traveled (VHT) can be seen between the scenarios. Table \@ref(tab:VMT) shows these metrics for each alternative and how they compare to the No-Build.

```{r VMT}
nbVMT <- read_csv("data/VMT/no-buildVMT.csv") %>% 
  mutate(Scenario = "No-Build")
dtVMT <- read_csv("data/VMT/downtownVMT.csv") %>% 
  mutate(Scenario = "Downtown")
ncVMT <- read_csv("data/VMT/ncVMT.csv") %>% 
  mutate(Scenario = "Neighborhood Centers")

VMT <- rbind(nbVMT, dtVMT, ncVMT)

VMT %<>% 
  dplyr::group_by(Scenario) %>% 
  dplyr::summarise("Total VMT (miles)" = sum(TOTAL_VMT),
            "Total VHT (hours)" = sum(TOTAL_VHT)) %>% 
  dplyr::arrange(-row_number())

nbVMT <- VMT$`Total VMT (miles)`[1]
nbVHT <- VMT$`Total VHT (hours)`[1]

VMT %>% 
  mutate(
    VMT = `Total VMT (miles)` - nbVMT,
    VHT = `Total VHT (hours)` - nbVHT,
    `%VMT` = VMT / nbVMT * 100,
    `%VHT` = VHT / nbVHT * 100
    ) %>% 
  kbl(digits = 2, caption = "VMT and VHT by Scenario", booktabs = T) %>% 
  kable_styling(latex_options = "hold_position") %>% 
  add_header_above(c(" " = 3, "Difference from No-Build" = 4))

```

Both the Neighborhood Centers and Downtown scenarios predict a decrease in both VMT and VHT, but the difference in the Downtown scenario is much more dramatic, with around a 10% reduction in VMT and a 12% reduction in VHT. This could do a lot to reduce emissions, and there could potentially be even more of a reduction if better transit infrastructure was built in the downtown area.

# Recommendation

These scenarios offer a snapshot of how densifying the downtown area could promote multimodal use and reduce emissions. While there’s more research to be done, we recommend densifying the downtown area. The congestion issue is localized and more easily solved by multi-modal improvements. In the neighborhood centers scenario, congestion on many local roads increased from the base model in different parts of the city. Planners would need to find solutions and funding to patch up multiple issue zones rather than the one issue zone of downtown. We assumed that the solution for downtown congestion would be less costly for one small area, but further cost analyses are important. Development of transit and more land use changes require additional research and modeling before taking the suggestion to densify downtown to the policy makers.

Mitigation of congestion is hardly the downtown option’s only virtue. It best promotes multi-modal transportation which we believe makes for more prosperous and pleasant city living. Benefits of robust multi-modal transportation systems include lower emissions, reduced traffic congestion, and increased aesthetic appeal of the area. Densifying the downtown area is predicted to significantly increase non-motorized transportation and more than double transit ridership. While both densifying projects save significant vehicle miles traveled and time spent traveling, the downtown model saves the most in both categories. Downtown reduces VMT by 440,040 miles more than the neighborhood centers. It also reduces VHT by 25,532 more hours.

Despite the need for further research in cost analysis, transit development, and other factors, we recommend densifying the downtown area of Roanoke. Concentrating a large portion of the jobs and residents in the downtown area yields many benefits for the people of Roanoke while generating relatively minimal complications.

\pagebreak

# Appendix {-}